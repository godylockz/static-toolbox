name: Build Hydra for Windows (MinGW)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
      # 1. 检出源码
      - name: Checkout source code
        uses: actions/checkout@v4

      # 2. 使用 Marketplace Action 安装 MinGW-w64
      - name: Set up MinGW
        uses: egor-tensin/setup-mingw@v2
        with:
          platform: x64
          toolchain: ucrt64  # 可选参数，指定工具链（默认 ucrt64）

      # 3. 安装额外依赖（如 OpenSSL、PCRE2 等）
      - name: Install dependencies
        run: |
          # 使用 MSYS2 的 pacman 安装额外依赖
          C:\msys64\usr\bin\bash.exe -c "pacman -Syu --noconfirm mingw-w64-ucrt-x86_64-gcc mingw-w64-ucrt-x86_64-make mingw-w64-ucrt-x86_64-pkg-config mingw-w64-ucrt-x86_64-zlib mingw-w64-ucrt-x86_64-openssl mingw-w64-ucrt-x86_64-pcre2"

      # 4. 设置环境变量（确保路径正确）
      - name: Set MinGW Path
        run: |
          echo "::add-path::C:\\msys64\\mingw64\\bin"
          echo "::add-path::C:\\msys64\\usr\\bin"

      # 5. 编译 Hydra
      - name: Build Hydra
        run: |
          # 克隆 Hydra 源码
          git clone https://github.com/vanhauser-thc/thc-hydra.git hydra-source
          cd hydra-source

          # 配置编译参数
          ./configure --host=x86_64-w64-mingw32 --prefix=C:/msys64/mingw64 --with-ssl=C:/msys64/mingw64 --disable-x11

          # 编译 Hydra
          make -j$(nproc)

          # 创建输出目录
          mkdir -p C:/hydra-win64

          # 复制编译结果
          cp src/hydra.exe C:/hydra-win64/
          cp README.md LICENSE docs/* C:/hydra-win64/

      # 6. 打包结果
      - name: Package Hydra
        run: |
          # 使用 PowerShell 打包为 ZIP
          Compress-Archive -Path C:/hydra-win64/* -DestinationPath C:/hydra-win64.zip

      # 7. 上传构建产物
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: hydra-win64
          path: C:/hydra-win64.zip
